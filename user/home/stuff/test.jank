#include <iostream>;
#include <assert>;
#include <string>;
#include <vector>;

i32 main(u64 argc, u8** argv) {
    cout << "UDP test" << "\n";
    cout.flush();

    i32 fd = sys_socket(2, 2, 0);
    assert(fd >= 0, "socket create failed");

    sockaddr_in local;
    local.sin_family = $u16 AF_INET;
    local.sin_port = $u16 4321;
    local.sin_addr = $u32 0;

    i32 res = sys_bind(fd, $sockaddr* @local, sizeof(sockaddr_in));
    assert(res >= 0, "failed to bind");

    sockaddr_in remote;
    remote.sin_family = $u16 AF_INET;
    remote.sin_port = $u16 4321;
    remote.sin_addr = $u32 (10 << 24 | 0 << 16 | 2 << 8 | 15 << 0);
    // remote.sin_addr = $u32 (127 << 24 | 0 << 16 | 0 << 8 | 1 << 0);
    // remote.sin_addr = $u32 (10 << 24 | 0 << 16 | 2 << 8 | 3 << 0);

    res = sys_connect(fd, $sockaddr* @remote, sizeof(sockaddr_in));
    cout << res << "\n";
    cout.flush();
    assert(res == 0, "connect failed");
    
    u8* msg = "bello bello mr li";
    i64 w_res = sys_write(fd, $void* msg, $u64 17);
    cout << w_res << "\n";
    cout.flush();
    assert(w_res == $i64 17, "write failed");
    
    u64 buf_size = $u64 128;
    u8* buf = $u8* malloc(buf_size);
    memset($void* $u64 @buf[0], 0, buf_size);

    sockaddr_in client_addr;
    u64 addr_len = sizeof(sockaddr_in);

    i32 len = sys_recvfrom(fd, $u8* @buf[0], buf_size - 0x1, 0, $sockaddr* @client_addr, @addr_len);
    cout << "got length: " << len << "\n";
    buf[len] = $u8 0;
    cout << $u8* @buf[0] << "\n";
    cout.flush();

    return 0;
}